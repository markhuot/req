!function(t){function e(e,a){for(var n=this,o=this.data("options"),i=this.data("inputName"),d=0;len=o.length,len>d;d++)if(o[d].id==e){if(o[d].selected&&!a)return;o[d].selected=!0,this.data("options",o);var l=t("<span />",{"data-id":o[d].id,"data-selected":o[d].selected,"data-token-item":!0,"class":"token-item"});l.html(o[d].html);var s=t("<input />",{type:"hidden",name:i,value:o[d].id});l.append(s);var c=t('<a href="#" data-remove class="token-item-remove">&times;</a>');l.append(c),n.append(l)}return this}t.fn.token=function(a){if("selectOption"==a){var n=Array.prototype.slice.call(arguments,1);return e.apply(this,n)}t.extend({},t.fn.token.defaults,a);return this.each(function(){var e=t(this).attr("name"),a=t(this).attr("id");t(this).hide(),t(this).removeAttr("name"),t(this).removeAttr("id");var n=[];t(this).find("option").each(function(){n.push({id:t(this).attr("value"),html:t(this).html(),selected:t(this).attr("selected")?!0:!1})});var o=t("<span />",{name:e,id:a,"data-token-field":!0,"class":"token-field"});o.data("options",n),o.data("inputName",e),o.data("originalInput",t(this));for(var i=0;len=n.length,len>i;i++)n[i].selected&&o.token("selectOption",n[i].id,!0);var d=t('<input type="text" data-token-input class="token-input" />');d.attr("id",a),t(o).append(d),t(this).after(o)})},t.fn.token.defaults={color:"#556b2f",backgroundColor:"white"},t("[data-token]").token(),t(document).on("click","[data-token-field] [data-remove]",function(){for(var e=t(this).closest("[data-token-item]"),a=t(this).closest("[data-token-field]"),n=a.data("options"),o=0;len=n.length,len>o;o++)n[o].id==e.data("id")&&(n[o].selected=!1);return a.data("options",n),t(this).closest("[data-token-field]").find("[data-token-input]").focus(),t(this).closest("[data-token-item]").remove(),!1}),t(document).on("click","[data-token-item]",function(){return t(this).attr("data-selected",!0).addClass("selected"),!1}),t(document).on("focus","[data-token-input]",function(){t("[data-token-optionList]").remove();var e=t(this),a=e.closest("[data-token-field]"),n=a.data("options"),o={defaultPrevented:!1,preventDefault:function(){o.defaultPrevented=!0},callback:function(a){for(var n=t("<ul />",{"data-token-optionList":!0,"class":"token-optionList"}),o=0;len=a.length,len>o;o++){var i=t("<li />",{"data-value":a[o].id,"data-token-option":!0,"class":"token-option"});a[o].text&&i.text(a[o].text),a[o].html&&i.html(a[o].html),n.append(i)}e.after(n)}};a.data("originalInput").trigger("lozenge:fetch",o),0==o.defaultPrevented&&o.callback(n)}),t(document).on("blur","[data-token-input]",function(){setTimeout(function(){t("[data-token-optionList]").remove()},500)}),t(document).on("click","[data-token-option]",function(){return t(this).closest("[data-token-field]").token("selectOption",t(this).data("value")),!1}),t(document).on("keyup","[data-token-input]",function(e){var a=t(this).val();if(""===a)return void t("[data-token-newOption]").remove();var n=t("[data-token-newOption]");if(!n.length)var n=t('<li data-token-newOption class="token-newOption" />').prependTo("[data-token-optionList]");return n.data("value",a),n.html(a),13==e.keyCode?!1:void 0}),t(document).on("click","[data-token-newOption]",function(){var e=t(this).closest("[data-token-field]"),a={value:t(this).data("value"),defaultPrevented:!1,preventDefault:function(){a.defaultPrevented=!0},callback:function(t){var a=e.data("options");a.push({id:t.id,html:t.html,selected:!1}),e.data("options",a),e.token("selectOption",t.id)}};e.data("originalInput").trigger("lozenge:store",a)})}(jQuery),$(document.body).removeClass("preload"),$("[data-note]").each(function(){var t=$(this),e=$(this).data("before"),a=$(this).data("after"),n=JsDiff.diffChars(e,a);n.forEach(function(e){var a=$("<span />",{"class":e.added?"note-added":e.removed?"note-removed":""});a.text(e.value),t.append(a)})}),$(document).on("lozenge:fetch","[data-tags]",function(t,e){console.log(this),e.preventDefault(),$.get(TAGS_URI,function(t){e.callback(t.map(function(t){return{id:t.id,html:t.name}}))})}),$(document).on("lozenge:store","[data-tags]",function(t,e){console.log(this),e.preventDefault(),$.post(TAGS_URI,{tag:{name:e.value}},function(t){e.callback({id:t.id,html:t.name})})}),$(document).on("lozenge:fetch","[data-search]",function(t,e){e.preventDefault();var a=[{id:"status:accepted",html:"Status: Accepted"}];e.callback(a)});