!function(t){function e(){this.containers=[],this.options=[]}function n(e,n){for(var a=this,o=this.data("options"),i=this.data("inputName"),d=0;len=o.length,len>d;d++)if(o[d].id==e){if(o[d].selected&&!n)return;o[d].selected=!0,this.data("options",o);var s=t("<span />",{"data-id":o[d].id,"data-selected":o[d].selected,"data-token-item":!0,"class":"token-item"});s.html(o[d].html);var l=t("<input />",{type:"hidden",name:i,value:o[d].id});s.append(l);var r=t('<a href="#" data-remove class="token-item-remove">&times;</a>');s.append(r),a.find("[data-token-input]").before(s)}return this}e.prototype.createOption=function(){return this},e.prototype.addOption=function(t,e){return this.options.push({key:t,label:e}),this},e.prototype.addOptions=function(t){for(var e=0,n=t.length;n>e;e++)this.addOption(t[e]);return this},e.prototype.clearOptions=function(){this.options=[]},e.prototype.find=function(t){for(var e=0,n=this.options.length;n>e;e++)if(this.options[e].key===t)return this.options[e];return!1},e.prototype.attach=function(t){this.containers.push(t)},t.fn.token=function(a){if("selectOption"==a){var o=Array.prototype.slice.call(arguments,1);return n.apply(this,o)}t.extend({},t.fn.token.defaults,a);return this.each(function(){var n=t(this).attr("name"),a=t(this).attr("id");t(this).hide(),t(this).removeAttr("name"),t(this).removeAttr("id");var o=t("<span />",{name:n,"data-token-field":!0,"class":"token-field"});o.data("inputName",n),o.data("originalInput",t(this)),o.data("optionList",new e);var i=[];t(this).find("option").each(function(){o.data("optionList").addOption(t(this).attr("value"),t(this).html()),i.push({id:t(this).attr("value"),html:t(this).html(),selected:t(this).attr("selected")?!0:!1})}),o.data("options",i);var d=t('<input type="text" data-token-input class="token-input" />');d.attr("id",a),t(o).append(d);for(var s=0;len=i.length,len>s;s++)i[s].selected&&o.token("selectOption",i[s].id,!0);t(this).after(o)})},t.fn.token.defaults={color:"#556b2f",backgroundColor:"white"},t("[data-token]").token(),t(document).on("click","[data-token-field] [data-remove]",function(){for(var e=t(this).closest("[data-token-item]"),n=t(this).closest("[data-token-field]"),a=n.data("options"),o=0;len=a.length,len>o;o++)a[o].id==e.data("id")&&(a[o].selected=!1);return n.data("options",a),t(this).closest("[data-token-field]").find("[data-token-input]").focus(),t(this).closest("[data-token-item]").remove(),!1}),t(document).on("click","[data-token-item]",function(){return t(this).attr("data-selected",!0).addClass("selected"),!1}),t(document).on("focus keyup","[data-token-input]",function(){var e=t(this),n=e.closest("[data-token-field]"),a=n.data("options"),o=n.data("optionList");o.attach(n);var i=n.find("[data-token-optionList]");i.length||(i=t("<ul />",{"data-token-optionList":!0,"class":"token-optionList"}),e.after(i));var d={value:t(this).val(),createOption:function(e){if(e){var n=i.find("[data-token-newOption]");n.length||(n=t("<li />",{"data-id":"null","data-value":e,"data-token-option":!0,"data-token-newOption":!0,"class":"token-newOption"}),i.prepend(n)),n.data("value",e),n.text(e)}else t("[data-token-newOption]").remove()},addOption:function(e){var o=i.find('[data-value="'+e.id+'"]');o.length||(o=t("<li />",{"data-value":e.id,"data-token-option":!0,"class":"token-option"}),e.text&&o.text(e.text),e.html&&o.html(e.html),i.append(o));for(var d=0;len=a.length,len>d;d++)if(a[d].id==e.id)return;a.push({id:e.id,html:e.html}),n.data("options",a)},addOptions:function(t){for(var e=0;len=t.length,len>e;e++)d.addOption(t[e])}},s=t.Event("lozenge:fetch");n.data("originalInput").trigger(s,d),s.isDefaultPrevented()===!1&&d.addOptions(a)}),t(document).on("blur","[data-token-input]",function(){setTimeout(function(){t("[data-token-optionList]").remove()},500)}),t(document).on("click","[data-token-option]",function(){return t(this).closest("[data-token-field]").token("selectOption",t(this).data("value")),!1}),t(document).on("click","[data-token-newOption]",function(){var e=t(this).closest("[data-token-field]"),n={id:t(this).data("id"),value:t(this).data("value"),defaultPrevented:!1,preventDefault:function(){n.defaultPrevented=!0},callback:function(t){var n=e.data("options");n.push({id:t.id,html:t.html,selected:!1}),e.data("options",n),e.token("selectOption",t.id)}},a=t.Event("lozenge:store");e.data("originalInput").trigger(a,n)})}(jQuery),$(document.body).removeClass("preload"),$("[data-note]").each(function(){var t=$(this),e=$(this).data("before"),n=$(this).data("after"),a=JsDiff.diffChars(e,n);a.forEach(function(e){var n=$("<span />",{"class":e.added?"note-added":e.removed?"note-removed":""});n.text(e.value),t.append(n)})}),$(document).on("lozenge:fetch","[data-tags]",function(t,e){t.preventDefault(),e.createOption(e.value),$.get(TAGS_URI,function(t){$(t).each(function(){this.name==e.value&&e.createOption(!1),e.addOption({id:this.id,html:this.name})})})}),$(document).on("lozenge:store","[data-tags]",function(t,e){t.preventDefault(),$.post(TAGS_URI,{tag:{name:e.value}},function(t){e.callback({id:t.id,html:t.name})})}),$(document).on("lozenge:fetch","[data-search]",function(t,e){t.preventDefault(),e.createOption(e.value),e.addOptions([{id:"status:pending",html:"Status: Pending"},{id:"status:accepted",html:"Status: Accepted"},{id:"status:rejected",html:"Status: Rejected"},{id:"status:delivered",html:"Status: Delivered"},{id:"status:closed",html:"Status: Closed"}])}),$(document).on("lozenge:store","[data-search]",function(t,e){t.preventDefault(),e.callback({id:e.value,html:e.value})});