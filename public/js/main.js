!function(t){function e(e,a){for(var n=this,o=this.data("options"),i=this.data("inputName"),d=0;len=o.length,len>d;d++)if(o[d].id==e){if(o[d].selected&&!a)return;o[d].selected=!0,this.data("options",o);var s=t("<span />",{"data-id":o[d].id,"data-selected":o[d].selected,"data-token-item":!0,"class":"token-item"});s.html(o[d].html);var l=t("<input />",{type:"hidden",name:i,value:o[d].id});s.append(l);var c=t('<a href="#" data-remove class="token-item-remove">&times;</a>');s.append(c),n.append(s)}return this}t.fn.token=function(a){if("selectOption"==a){var n=Array.prototype.slice.call(arguments,1);return e.apply(this,n)}t.extend({},t.fn.token.defaults,a);return this.each(function(){var e=t(this).attr("name"),a=t(this).attr("id");t(this).hide(),t(this).removeAttr("name"),t(this).removeAttr("id");var n=[];t(this).find("option").each(function(){n.push({id:t(this).attr("value"),html:t(this).html(),selected:t(this).attr("selected")?!0:!1})});var o=t("<span />",{name:e,id:a,"data-token-field":!0,"class":"token-field"});o.data("options",n),o.data("inputName",e),o.data("originalInput",t(this));for(var i=0;len=n.length,len>i;i++)n[i].selected&&o.token("selectOption",n[i].id,!0);var d=t('<input type="text" data-token-input class="token-input" />');d.attr("id",a),t(o).append(d),t(this).after(o)})},t.fn.token.defaults={color:"#556b2f",backgroundColor:"white"},t("[data-token]").token(),t(document).on("click","[data-token-field] [data-remove]",function(){for(var e=t(this).closest("[data-token-item]"),a=t(this).closest("[data-token-field]"),n=a.data("options"),o=0;len=n.length,len>o;o++)n[o].id==e.data("id")&&(n[o].selected=!1);return a.data("options",n),t(this).closest("[data-token-field]").find("[data-token-input]").focus(),t(this).closest("[data-token-item]").remove(),!1}),t(document).on("click","[data-token-item]",function(){return t(this).attr("data-selected",!0).addClass("selected"),!1}),t(document).on("focus keyup","[data-token-input]",function(){var e=t(this),a=e.closest("[data-token-field]"),n=a.data("options"),o=a.find("[data-token-optionList]");o.length||(o=t("<ul />",{"data-token-optionList":!0,"class":"token-optionList"}),e.after(o));var i={value:t(this).val(),defaultPrevented:!1,preventDefault:function(){i.defaultPrevented=!0},createOption:function(e){if(e){var a=o.find("[data-token-newOption]");a.length||(a=t("<li />",{"data-id":"null","data-value":e,"data-token-option":!0,"data-token-newOption":!0,"class":"token-newOption"}),o.prepend(a)),a.data("value",e),a.text(e)}else t("[data-token-newOption]").remove()},addOption:function(e){var a=o.find('[data-value="'+e.id+'"]');a.length||(a=t("<li />",{"data-value":e.id,"data-token-option":!0,"class":"token-option"}),e.text&&a.text(e.text),e.html&&a.html(e.html),o.append(a))},addOptions:function(t){for(var e=0;len=t.length,len>e;e++)i.addOption(t[e])}};a.data("originalInput").trigger("lozenge:fetch",i),0==i.defaultPrevented&&i.addOptions(n)}),t(document).on("blur","[data-token-input]",function(){setTimeout(function(){t("[data-token-optionList]").remove()},500)}),t(document).on("click","[data-token-option]",function(){return t(this).closest("[data-token-field]").token("selectOption",t(this).data("value")),!1}),t(document).on("click","[data-token-newOption]",function(){var e=t(this).closest("[data-token-field]"),a={id:t(this).data("id"),value:t(this).data("value"),defaultPrevented:!1,preventDefault:function(){a.defaultPrevented=!0},callback:function(t){var a=e.data("options");a.push({id:t.id,html:t.html,selected:!1}),e.data("options",a),e.token("selectOption",t.id)}};e.data("originalInput").trigger("lozenge:store",a)})}(jQuery),$(document.body).removeClass("preload"),$("[data-note]").each(function(){var t=$(this),e=$(this).data("before"),a=$(this).data("after"),n=JsDiff.diffChars(e,a);n.forEach(function(e){var a=$("<span />",{"class":e.added?"note-added":e.removed?"note-removed":""});a.text(e.value),t.append(a)})}),$(document).on("lozenge:fetch","[data-tags]",function(t,e){e.preventDefault(),e.createOption(e.value),$.get(TAGS_URI,function(t){$(t).each(function(){this.name==e.value&&e.createOption(!1),e.addOption({id:this.id,html:this.name})})})}),$(document).on("lozenge:store","[data-tags]",function(t,e){e.preventDefault(),$.post(TAGS_URI,{tag:{name:e.value}},function(t){e.callback({id:t.id,html:t.name})})}),$(document).on("lozenge:fetch","[data-search]",function(t,e){e.preventDefault(),e.createOption(e.value),e.addOptions([{id:"status:pending",html:"Status: Pending"},{id:"status:accepted",html:"Status: Accepted"},{id:"status:rejected",html:"Status: Rejected"},{id:"status:delivered",html:"Status: Delivered"},{id:"status:closed",html:"Status: Closed"}])});